<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Enquiry Form Plugin: C:/Users/nashc/GitHub Projects/Enquiry-Form/admin/partials/ef-admin-export.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Enquiry Form Plugin<span id="projectnumber">&#160;0.8.3 Dev</span>
   </div>
   <div id="projectbrief">A simple and customizable WordPress plugin that extends WooCommerce functionality by adding an enquiry system for products. Users can select items, add them to an enquiry cart, and submit their inquiries via a form.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('ef-admin-export_8php_source.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">ef-admin-export.php</div></div>
</div><!--header-->
<div class="contents">
<a href="ef-admin-export_8php.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span>&lt;?php</div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span> </div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;ABSPATH&#39;</span>)) {</div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span>    exit;</div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span>}</div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span> </div>
<div class="foldopen" id="foldopen00007" data-start="{" data-end="}">
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno"><a class="line" href="ef-admin-export_8php.html#aa26ae3181f65ca4dce103d304f3f8024">    7</a></span><span class="keyword">function</span> <a class="code hl_function" href="ef-admin-export_8php.html#aa26ae3181f65ca4dce103d304f3f8024">display_enquiry_export_page</a>() {</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span>    <span class="comment">// Display error message if exists</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span>    $error_message = get_transient(<span class="stringliteral">&#39;ef_export_error&#39;</span>);</div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span>    <span class="keywordflow">if</span> ($error_message) {</div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span>        delete_transient(<span class="stringliteral">&#39;ef_export_error&#39;</span>);</div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span>        ?&gt;</div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span>        &lt;div <span class="keyword">class</span>=<span class="stringliteral">&quot;notice notice-error is-dismissible&quot;</span>&gt;</div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span>            &lt;p&gt;&lt;?php echo esc_html($error_message); ?&gt;&lt;/p&gt;</div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span>        &lt;/div&gt;</div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span>        &lt;?php</div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span>    }</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span> </div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span>    <span class="comment">// // Check if the current user is &quot;Nash_Intern&quot;</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span>    <span class="comment">// $current_user = wp_get_current_user();</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>    <span class="comment">// if ($current_user-&gt;user_login !== &#39;Nash_Intern&#39;) {</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>    <span class="comment">//     echo &#39;&lt;div class=&quot;wrap&quot;&gt;&lt;h1&gt;Work in Progress&lt;/h1&gt;&lt;p&gt;This export page is currently under development. Please check back later.&lt;/p&gt;&lt;/div&gt;&#39;;</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>    <span class="comment">//     echo &#39;&lt;br&gt;&#39;;</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>    <span class="comment">//     echo &#39;&lt;p&gt;If you need to access this page, please contact the developer at &lt;a href=&quot;mailto:nashc.mad@gmail.com&quot;&gt;nashc.mad@gmail.com&lt;/a&gt;.&lt;/p&gt;&#39;;</span></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>    <span class="comment">//     echo &#39;&lt;br&gt;&#39;;</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>    <span class="comment">//     echo &#39;&lt;a href=&quot;?page=ef-settings&quot;&gt;Back to Settings&lt;/a&gt;&#39;;</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>    <span class="comment">//     return;</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>    <span class="comment">// }</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span> </div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>    <span class="comment">// Display the export form</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>    ?&gt;</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>    &lt;div <span class="keyword">class</span>=<span class="stringliteral">&quot;wrap&quot;</span>&gt;</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>        &lt;h1&gt;&lt;?php echo esc_html(get_admin_page_title()); ?&gt;&lt;/h1&gt;</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>        &lt;form method=<span class="stringliteral">&quot;get&quot;</span> action=<span class="stringliteral">&quot;&lt;?php echo admin_url(&#39;admin-post.php&#39;); ?&gt;&quot;</span>&gt;</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>            &lt;input type=<span class="stringliteral">&quot;hidden&quot;</span> name=<span class="stringliteral">&quot;action&quot;</span> value=<span class="stringliteral">&quot;export_enquiries&quot;</span>&gt;</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>            &lt;table <span class="keyword">class</span>=<span class="stringliteral">&quot;form-table&quot;</span>&gt;</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>                &lt;tr&gt;</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>                    &lt;th scope=<span class="stringliteral">&quot;row&quot;</span>&gt;&lt;label <span class="keywordflow">for</span>=<span class="stringliteral">&quot;status&quot;</span>&gt;Status&lt;/label&gt;&lt;/th&gt;</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>                    &lt;td&gt;</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>                        &lt;select name=<span class="stringliteral">&quot;status&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;status&quot;</span>&gt;</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>                            &lt;option value=<span class="stringliteral">&quot;all&quot;</span>&gt;All&lt;/option&gt;</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>                            &lt;option value=<span class="stringliteral">&quot;Unreplied&quot;</span>&gt;Unreplied&lt;/option&gt;</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>                            &lt;option value=<span class="stringliteral">&quot;Replied&quot;</span>&gt;Replied&lt;/option&gt;</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>                            &lt;option value=<span class="stringliteral">&quot;Done&quot;</span>&gt;Done&lt;/option&gt;</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>                        &lt;/select&gt;</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>                    &lt;/td&gt;</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>                &lt;/tr&gt;</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>                &lt;tr&gt;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>                    &lt;th scope=<span class="stringliteral">&quot;row&quot;</span>&gt;&lt;label <span class="keywordflow">for</span>=<span class="stringliteral">&quot;start_date&quot;</span>&gt;Start Date (optional)&lt;/label&gt;&lt;/th&gt;</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>                    &lt;td&gt;&lt;input type=<span class="stringliteral">&quot;date&quot;</span> name=<span class="stringliteral">&quot;start_date&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;start_date&quot;</span>&gt;&lt;/td&gt;</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>                &lt;/tr&gt;</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>                &lt;tr&gt;</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>                    &lt;th scope=<span class="stringliteral">&quot;row&quot;</span>&gt;&lt;label <span class="keywordflow">for</span>=<span class="stringliteral">&quot;end_date&quot;</span>&gt;End Date (optional)&lt;/label&gt;&lt;/th&gt;</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>                    &lt;td&gt;&lt;input type=<span class="stringliteral">&quot;date&quot;</span> name=<span class="stringliteral">&quot;end_date&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;end_date&quot;</span>&gt;&lt;/td&gt;</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>                &lt;/tr&gt;</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>            &lt;/table&gt;</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>            &lt;p <span class="keyword">class</span>=<span class="stringliteral">&quot;submit&quot;</span>&gt;</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>                &lt;input type=<span class="stringliteral">&quot;submit&quot;</span> <span class="keyword">class</span>=<span class="stringliteral">&quot;button button-primary&quot;</span> value=<span class="stringliteral">&quot;Export CSV&quot;</span>&gt;</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>            &lt;/p&gt;</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>        &lt;/form&gt;</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>    &lt;/div&gt;</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>    &lt;?php</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>}</div>
</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span> </div>
<div class="foldopen" id="foldopen00065" data-start="{" data-end="}">
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno"><a class="line" href="ef-admin-export_8php.html#a0741428d85c47c5f491f50fcce770cd3">   65</a></span><span class="keyword">function</span> <a class="code hl_function" href="ef-admin-export_8php.html#a0741428d85c47c5f491f50fcce770cd3">export_enquiries_to_csv</a>() {</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>        <span class="comment">// Verify user permissions</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>        <span class="keywordflow">if</span> (!current_user_can(<span class="stringliteral">&#39;manage_options&#39;</span>)) {</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&#39;Insufficient permissions to export data.&#39;</span>);</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>        }</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span> </div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>        global $wpdb;</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>        </div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>        <span class="comment">// Get and sanitize parameters</span></div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>        $status = isset($_GET[<span class="stringliteral">&#39;status&#39;</span>]) ? sanitize_text_field($_GET[<span class="stringliteral">&#39;status&#39;</span>]) : <span class="stringliteral">&#39;all&#39;</span>;</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>        $start_date = isset($_GET[<span class="stringliteral">&#39;start_date&#39;</span>]) ? sanitize_text_field($_GET[<span class="stringliteral">&#39;start_date&#39;</span>]) : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>        $end_date = isset($_GET[<span class="stringliteral">&#39;end_date&#39;</span>]) ? sanitize_text_field($_GET[<span class="stringliteral">&#39;end_date&#39;</span>]) : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span> </div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>        <span class="comment">// Define table names</span></div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>        $enquiries_table = $wpdb-&gt;prefix . <span class="stringliteral">&#39;ef_enquiries&#39;</span>;</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>        $cart_items_table = $wpdb-&gt;prefix . <span class="stringliteral">&#39;ef_cart_items&#39;</span>;</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span> </div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>        <span class="comment">// Build the query</span></div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>        $query = <span class="stringliteral">&quot;SELECT e.id AS enquiry_id, e.subject, e.content, e.name, e.company, </span></div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span><span class="stringliteral">                        e.email, e.phone, e.created_at, e.status, </span></div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span><span class="stringliteral">                        ci.product_name, ci.sku</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span><span class="stringliteral">                 FROM $enquiries_table AS e</span></div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span><span class="stringliteral">                 LEFT JOIN $cart_items_table AS ci ON e.id = ci.enquiry_id</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span><span class="stringliteral">                 WHERE 1=1&quot;</span>;</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>        </div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>        $query_params = array();</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span> </div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>        <span class="comment">// Add status filter</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>        <span class="keywordflow">if</span> ($status !== <span class="stringliteral">&#39;all&#39;</span>) {</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>            $query .= <span class="stringliteral">&quot; AND e.status = %s&quot;</span>;</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>            $query_params[] = $status;</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>        }</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span> </div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>        <span class="comment">// Add date range filters</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>        <span class="keywordflow">if</span> (!empty($start_date)) {</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>            $query .= <span class="stringliteral">&quot; AND e.created_at &gt;= %s&quot;</span>;</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>            $query_params[] = $start_date . <span class="stringliteral">&#39; 00:00:00&#39;</span>;</div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>        }</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>        <span class="keywordflow">if</span> (!empty($end_date)) {</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>            $query .= <span class="stringliteral">&quot; AND e.created_at &lt;= %s&quot;</span>;</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>            $query_params[] = $end_date . <span class="stringliteral">&#39; 23:59:59&#39;</span>;</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>        }</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span> </div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>        $query .= <span class="stringliteral">&quot; ORDER BY e.id, ci.id&quot;</span>;</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span> </div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>        <span class="comment">// Prepare and execute the query</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>        $final_query = $query_params ? $wpdb-&gt;prepare($query, $query_params) : $query;</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>        $results = $wpdb-&gt;get_results($final_query, ARRAY_A);</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span> </div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>        <span class="keywordflow">if</span> (!$results) {</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&#39;No data available for the selected criteria.&#39;</span>);</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>        }</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span> </div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>        <span class="comment">// Set headers for CSV export</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>        header(<span class="stringliteral">&#39;Content-Type: text/csv; charset=utf-8&#39;</span>);</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>        header(<span class="stringliteral">&#39;Content-Disposition: attachment;filename=enquiries_export_&#39;</span> . date(<span class="stringliteral">&#39;Y-m-d&#39;</span>) . <span class="stringliteral">&#39;.csv&#39;</span>);</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>        header(<span class="stringliteral">&#39;Pragma: no-cache&#39;</span>);</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>        header(<span class="stringliteral">&#39;Expires: 0&#39;</span>);</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>        </div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>        <span class="comment">// Open output stream</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>        $output = fopen(<span class="stringliteral">&#39;php://output&#39;</span>, <span class="charliteral">&#39;w&#39;</span>);</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>        <span class="keywordflow">if</span> ($output === <span class="keyword">false</span>) {</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&#39;Failed to open output stream&#39;</span>);</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>        }</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>        </div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>        <span class="comment">// Write CSV headers</span></div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>        fputcsv($output, array(<span class="stringliteral">&#39;Enquiry ID&#39;</span>, <span class="stringliteral">&#39;Subject&#39;</span>, <span class="stringliteral">&#39;Content&#39;</span>, <span class="stringliteral">&#39;Name&#39;</span>, <span class="stringliteral">&#39;Company&#39;</span>, </div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>                              <span class="stringliteral">&#39;Email&#39;</span>, <span class="stringliteral">&#39;Phone&#39;</span>, <span class="stringliteral">&#39;Order Time&#39;</span>, <span class="stringliteral">&#39;Status&#39;</span>, </div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>                              <span class="stringliteral">&#39;Product Name&#39;</span>, <span class="stringliteral">&#39;SKU&#39;</span>));</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span> </div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>        <span class="comment">// Write data rows</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>        <span class="keywordflow">foreach</span> ($results as $row) {</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>            fputcsv($output, $row);</div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>        }</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span> </div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>        fclose($output);</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>        </div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>        <span class="comment">// Log successful export</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>        <a class="code hl_function" href="class_e_f___logger.html#a1b76ab17849fbe5c74c4ec26534f4d9a">EF_Logger::log</a>(<span class="stringliteral">&#39;CSV export completed successfully&#39;</span>, <a class="code hl_variable" href="class_e_f___logger.html#af2d1bd27ecbe33ecaadb558404e9c669">EF_Logger::INFO</a>, [</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>            <span class="stringliteral">&#39;count&#39;</span> =&gt; count($results),</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>            <span class="stringliteral">&#39;status_filter&#39;</span> =&gt; $status,</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>            <span class="stringliteral">&#39;start_date&#39;</span> =&gt; $start_date,</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>            <span class="stringliteral">&#39;end_date&#39;</span> =&gt; $end_date,</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>            <span class="stringliteral">&#39;user&#39;</span> =&gt; wp_get_current_user()-&gt;user_login</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>        ]);</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span> </div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>        exit;</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span> </div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>    } <span class="keywordflow">catch</span> (Exception $e) {</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>        <a class="code hl_function" href="class_e_f___logger.html#a1b76ab17849fbe5c74c4ec26534f4d9a">EF_Logger::log</a>(<span class="stringliteral">&#39;CSV export failed&#39;</span>, <a class="code hl_variable" href="class_e_f___logger.html#a7f79d7b73cfb40bb7855d4260393cc0f">EF_Logger::ERROR</a>, [</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>            <span class="stringliteral">&#39;error&#39;</span> =&gt; $e-&gt;getMessage(),</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>            <span class="stringliteral">&#39;trace&#39;</span> =&gt; $e-&gt;getTraceAsString(),</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>            <span class="stringliteral">&#39;status_filter&#39;</span> =&gt; $status ?? <span class="stringliteral">&#39;all&#39;</span>,</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>            <span class="stringliteral">&#39;start_date&#39;</span> =&gt; $start_date ?? <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>            <span class="stringliteral">&#39;end_date&#39;</span> =&gt; $end_date ?? <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>            <span class="stringliteral">&#39;user&#39;</span> =&gt; wp_get_current_user()-&gt;user_login</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>        ]);</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span> </div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>        <span class="comment">// Store the error message in transient</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>        set_transient(<span class="stringliteral">&#39;ef_export_error&#39;</span>, $e-&gt;getMessage(), 45);</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>        </div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>        <span class="comment">// Redirect back to the export page</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>        wp_redirect(add_query_arg(</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>            array(<span class="stringliteral">&#39;page&#39;</span> =&gt; <span class="stringliteral">&#39;ef-export&#39;</span>, <span class="stringliteral">&#39;error&#39;</span> =&gt; <span class="charliteral">&#39;1&#39;</span>),</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>            admin_url(<span class="stringliteral">&#39;admin.php&#39;</span>)</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>        ));</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>        exit;</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>    }</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>}</div>
</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span> </div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span><span class="comment">// Hook the export function</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>add_action(<span class="stringliteral">&#39;admin_post_export_enquiries&#39;</span>, <span class="stringliteral">&#39;export_enquiries_to_csv&#39;</span>);</div>
<div class="ttc" id="aclass_e_f___logger_html_a1b76ab17849fbe5c74c4ec26534f4d9a"><div class="ttname"><a href="class_e_f___logger.html#a1b76ab17849fbe5c74c4ec26534f4d9a">EF_Logger\log</a></div><div class="ttdeci">static log($message, $level=self::INFO, $context=array())</div><div class="ttdef"><b>Definition</b> <a href="class-ef-logger_8php_source.html#l00031">class-ef-logger.php:31</a></div></div>
<div class="ttc" id="aclass_e_f___logger_html_a7f79d7b73cfb40bb7855d4260393cc0f"><div class="ttname"><a href="class_e_f___logger.html#a7f79d7b73cfb40bb7855d4260393cc0f">EF_Logger\ERROR</a></div><div class="ttdeci">const ERROR</div><div class="ttdef"><b>Definition</b> <a href="class-ef-logger_8php_source.html#l00007">class-ef-logger.php:7</a></div></div>
<div class="ttc" id="aclass_e_f___logger_html_af2d1bd27ecbe33ecaadb558404e9c669"><div class="ttname"><a href="class_e_f___logger.html#af2d1bd27ecbe33ecaadb558404e9c669">EF_Logger\INFO</a></div><div class="ttdeci">const INFO</div><div class="ttdef"><b>Definition</b> <a href="class-ef-logger_8php_source.html#l00009">class-ef-logger.php:9</a></div></div>
<div class="ttc" id="aef-admin-export_8php_html_a0741428d85c47c5f491f50fcce770cd3"><div class="ttname"><a href="ef-admin-export_8php.html#a0741428d85c47c5f491f50fcce770cd3">export_enquiries_to_csv</a></div><div class="ttdeci">export_enquiries_to_csv()</div><div class="ttdef"><b>Definition</b> <a href="#l00065">ef-admin-export.php:65</a></div></div>
<div class="ttc" id="aef-admin-export_8php_html_aa26ae3181f65ca4dce103d304f3f8024"><div class="ttname"><a href="ef-admin-export_8php.html#aa26ae3181f65ca4dce103d304f3f8024">display_enquiry_export_page</a></div><div class="ttdeci">if(!defined( 'ABSPATH')) display_enquiry_export_page()</div><div class="ttdef"><b>Definition</b> <a href="#l00007">ef-admin-export.php:7</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_46dc8ac68f57394fbc4c170849c8cd59.html">GitHub Projects</a></li><li class="navelem"><a class="el" href="dir_dc0d924a75f365793828bda6b84bb026.html">Enquiry-Form</a></li><li class="navelem"><a class="el" href="dir_5c0961b2cb858bd2ea44554d053806b1.html">admin</a></li><li class="navelem"><a class="el" href="dir_b535373d849ff059866cc270a97fd682.html">partials</a></li><li class="navelem"><a class="el" href="ef-admin-export_8php.html">ef-admin-export.php</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
